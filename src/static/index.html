<!doctype html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Property Agent Assistant</title>
    <style>
      body{font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial; margin:0; padding:0; background:#f7f7f8}
      .container{max-width:800px;margin:40px auto;background:#fff;padding:20px;border-radius:12px;box-shadow:0 6px 24px rgba(0,0,0,0.08)}
      header{display:flex;justify-content:space-between;align-items:center}
      .modes button{margin-left:8px;padding:8px 12px;border-radius:8px;border:none;background:#007aff;color:#fff}
      textarea{width:100%;height:120px;margin-top:12px;padding:10px;border-radius:8px;border:1px solid #e6e6e9}
      #send{margin-top:8px;padding:10px 14px;border-radius:8px;border:none;background:#34c759;color:#fff}
      #output{white-space:pre-wrap;background:#f3f4f6;padding:12px;border-radius:8px;margin-top:12px;min-height:80px}
    </style>
  </head>
  <body>
    <div class="container">
      <header>
        <h2>Property Agent Assistant</h2>
        <div class="modes">
          <button id="mode-agent">中介模式</button>
          <button id="mode-buyer">客户模式</button>
          <button id="mode-admin">Admin</button>
        </div>
      </header>

      <div>
        <textarea id="query" placeholder="输入你的问题，例如：HDB购房流程"></textarea>
        <div>
          <button id="send">发送</button>
        </div>
        <div id="output"></div>
      </div>
    </div>

    <script>
      let mode = 'buyer'
      document.getElementById('mode-agent').onclick = ()=> mode='agent'
      document.getElementById('mode-buyer').onclick = ()=> mode='buyer'
      document.getElementById('mode-admin').onclick = ()=> mode='admin'

      document.getElementById('send').onclick = async ()=>{
        const q = document.getElementById('query').value
        if(!q) return
        document.getElementById('output').textContent = ''
        const evt = new EventSource('/api/query-sse?mode='+encodeURIComponent(mode)+'&q='+encodeURIComponent(q))
        // fallback to fetch SSE endpoint below
        // Use fetch POST as implemented by server (/api/query) which returns text/event-stream
        const res = await fetch('/api/query', {
          method:'POST',headers:{'Content-Type':'application/json'},body: JSON.stringify({mode,query:q})
        })
        const reader = res.body.getReader()
        const decoder = new TextDecoder()
        while(true){
          const {done, value} = await reader.read()
          if(done) break
          const chunk = decoder.decode(value)
          // SSE frames may come; strip `data: ` prefixes
          const clean = chunk.replace(/data: /g,'')
          document.getElementById('output').textContent += clean
        }
      }
    </script>
  </body>
</html>
